{% extends "layout.html" %}

{% block title %}
<h2>Advisor Agent</h2>
{% endblock %}

{% block content %}
<div class="card">
    <div style="margin-bottom: 2rem;">
        <h3 style="font-weight: 700;">Individual Profile Diagnosis</h3>
        <p style="color: var(--text-muted); font-size: 0.9rem;">Analyze student details using Gemini AI to generate
            personalized pedagogical advice.</p>
    </div>

    <form id="diagnostic-form">
        <div class="grid-form">
            <div class="form-section">
                <h4 style="margin-bottom: 1rem; color: var(--primary);">Identity & Region</h4>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" class="form-control" name="Name" value="Abdullah" required>
                </div>
                <div class="form-group">
                    <label>Age</label>
                    <input type="number" class="form-control" name="Age" value="20" required>
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select class="form-control" name="Gender">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Province</label>
                    <select class="form-control" name="Province">
                        <option value="Sindh">Sindh</option>
                        <option value="Punjab">Punjab</option>
                        <option value="KPK">KPK</option>
                        <option value="Balochistan">Balochistan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" class="form-control" name="City" value="Karachi" required>
                </div>
            </div>

            <div class="form-section">
                <h4 style="margin-bottom: 1rem; color: var(--primary);">Socio-Economic</h4>
                <div class="form-group">
                    <label>Family Income</label>
                    <select class="form-control" name="Family_Income_PKR">
                        <option value="Low (<30k)">Low (<30k)< /option>
                        <option value="Lower-Middle (30k-60k)">Lower-Middle (30k-60k)</option>
                        <option value="Middle (60k-120k)">Middle (60k-120k)</option>
                        <option value="Upper-Middle (120k-250k)">Upper-Middle (120k-250k)</option>
                        <option value="High (>250k)">High (>250k)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Internet Access</label>
                    <select class="form-control" name="Internet_Access">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Device Available</label>
                    <select class="form-control" name="Device_Available">
                        <option value="Laptop">Laptop</option>
                        <option value="Mobile">Mobile</option>
                        <option value="Desktop">Desktop</option>
                        <option value="None">None</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Part-time Job</label>
                    <select class="form-control" name="Part_Time_Job">
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Electricity</label>
                    <select class="form-control" name="Electricity_Availability">
                        <option value="Consistent">Consistent</option>
                        <option value="Frequent Outages">Frequent Outages</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <h4 style="margin-bottom: 1rem; color: var(--primary);">Academic Discipline</h4>
                <div class="form-group">
                    <label>Current CGPA</label>
                    <input type="number" step="0.01" class="form-control" name="CGPA" value="2.8" required>
                </div>
                <div class="form-group">
                    <label>Attendance %</label>
                    <input type="number" class="form-control" name="Attendance_Percentage" value="75" required>
                </div>
                <div class="form-group">
                    <label>Weekly Study Hours</label>
                    <input type="number" class="form-control" name="Study_Hours_Per_Week" value="12" required>
                </div>
                <div class="form-group">
                    <label>Motivation Level</label>
                    <select class="form-control" name="Motivation_Level">
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Parents Education</label>
                    <select class="form-control" name="Parents_Education">
                        <option value="Graduate">Graduate</option>
                        <option value="Postgraduate">Postgraduate</option>
                        <option value="Matric">Matric</option>
                        <option value="Primary">Primary</option>
                        <option value="Uneducated">Uneducated</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Hidden Defaults -->
        <input type="hidden" name="Private_Tuition" value="No">
        <input type="hidden" name="School_Type" value="Public">
        <input type="hidden" name="Medium_of_Instruction" value="English">
        <input type="hidden" name="Distance_to_Institute_km" value="5">
        <input type="hidden" name="Transport_Mode" value="Bus">
        <input type="hidden" name="Parental_Support_Level" value="Medium">
        <input type="hidden" name="Health_Issues" value="None">
        <input type="hidden" name="Extra_Curricular" value="None">

        <div style="margin-top: 2rem;">
            <button type="submit" class="btn-primary" id="submit-btn">Run Smart Diagnostic</button>
        </div>
    </form>
</div>

<!-- Results Area -->
<div class="result-card" id="results-area">
    <div class="card">
        <div style="display: flex; gap: 2rem; margin-bottom: 1.5rem;">
            <div class="stat-card" style="flex: 1; text-align: center;">
                <div class="stat-label">ACADEMIC STANDING</div>
                <div class="stat-value" id="res-perf" style="color: var(--primary);">---</div>
            </div>
            <div class="stat-card" style="flex: 1; text-align: center;">
                <div class="stat-label">ADVICE STATUS</div>
                <div class="stat-value" id="res-advice-status" style="color: var(--warning);">---</div>
            </div>
        </div>
        <div class="advice-box">
            <h4 style="margin-bottom: 0.5rem;"><ion-icon name="sparkles-outline"></ion-icon> Gemini Advising Agent</h4>
            <div id="res-advice">Generating high-impact advice...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('diagnostic-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        const resultsArea = document.getElementById('results-area');

        btn.innerHTML = 'Scanning Profile...';
        btn.disabled = true;

        const formData = new FormData(this);
        const payload = {};
        formData.forEach((value, key) => {
            // Handle numeric conversion
            if (['Age', 'CGPA', 'Attendance_Percentage', 'Study_Hours_Per_Week', 'Distance_to_Institute_km'].includes(key)) {
                payload[key] = parseFloat(value);
            } else {
                payload[key] = value;
            }
        });

        try {
            const response = await fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('res-perf').innerText = data.Performance_Class;
                document.getElementById('res-advice-status').innerText = data.Needs_Advice;
                document.getElementById('res-advice').innerText = data.Advice;

                // Set colors
                const perfEl = document.getElementById('res-perf');
                if (data.Performance_Class === 'Good') perfEl.style.color = 'var(--success)';
                else if (data.Performance_Class === 'Weak') perfEl.style.color = 'var(--danger)';
                else perfEl.style.color = 'var(--primary)';

                const adviceEl = document.getElementById('res-advice-status');
                if (data.Needs_Advice === 'Needs Advice') adviceEl.style.color = 'var(--warning)';
                else adviceEl.style.color = 'var(--success)';

                resultsArea.style.display = 'block';
                resultsArea.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Error: ' + data.detail);
            }
        } catch (err) {
            alert('Connection error. Is the backend running?');
        } finally {
            btn.innerHTML = 'Run Smart Diagnostic';
            btn.disabled = false;
        }
    });
</script>
{% endblock %}